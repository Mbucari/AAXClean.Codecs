on:
  workflow_call:
    inputs:
      architecture:
        type: string
        description: "CPU architecture targeted by the build."
        required: true
      runner:
        type: string
        required: true
      ffmpeg-version:
        type: string
        required: true
      msystem:
        type: string
        required: true
  
jobs:
  build:
    name: "Windows-${{ inputs.architecture }}"
    runs-on: ${{ inputs.runner }}
    defaults:
      run:
        shell: msys2 {0}
    steps:
    
      - uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ inputs.msystem }}
          install: >-
            unzip
            perl
          pacboy: >-
            gcc:p
            nasm:p
            autotools:p
            lame:p
            fdk-aac:p
        
      - uses: actions/checkout@v6
      
      - name: Build FFMpeg
        id: ffmpeg
        working-directory: ./src
        run: |
          FFMPEG_NAME="ffmpeg-${{ inputs.ffmpeg-version }}"
          FFMPEG_MAIN=$(pwd)/$FFMPEG_NAME
          echo $FFMPEG_MAIN
          echo 
          curl -k -o $FFMPEG_NAME.tar.xz -L0 $URL "https://ffmpeg.org/releases/$FFMPEG_NAME.tar.xz"
          echo "Extracting $FFMPEG_NAME.tar.xz"
          tar -xf ./$FFMPEG_NAME.tar.xz
          rm $FFMPEG_NAME.tar.xz
          echo "Building $FFMPEG_NAME"
          cd $FFMPEG_MAIN
          ./configure --disable-swscale --disable-avdevice --disable-doc --disable-v4l2-m2m --disable-vaapi --disable-vdpau --disable-network --disable-libxcb --disable-libxcb-xfixes --disable-libxcb-shape --disable-zlib --disable-iconv --disable-alsa --disable-shared --enable-static --disable-doc --disable-symver --disable-programs --disable-debug --enable-pic --disable-everything --enable-decoder=pcm_f32le --enable-decoder=pcm_s16le --enable-encoder=pcm_f32le --enable-encoder=pcm_s16le --enable-demuxer=pcm_f32le --enable-demuxer=pcm_s16le --enable-muxer=pcm_f32le --enable-muxer=pcm_s16le --enable-filter=aresample --enable-filter=asetnsamples --enable-libfdk_aac --enable-nonfree --enable-decoder=libfdk_aac --enable-encoder=libfdk_aac --enable-decoder=eac3 --enable-libmp3lame --enable-encoder=libmp3lame --disable-pthreads --disable-w32threads
          make -j $(nproc)
          echo "FFMPEG_MAIN=${FFMPEG_MAIN}" >> "${GITHUB_OUTPUT}"

      - name: Build libAAXCleanNative
        working-directory: ./src
        run: |
          DEST_DIR=runtimes/win-${{ inputs.architecture }}/native
          mkdir -p $DEST_DIR
          FFMPEG_MAIN=${{ steps.ffmpeg.outputs.FFMPEG_MAIN }}
          cd AAXCleanNative
          
          gcc -v -static -fPIC -Wno-error=incompatible-pointer-types -Wno-error=int-conversion -c AacDecoder.c -c AacEncoder.c -I$FFMPEG_MAIN
          gcc -shared -static -fPIC -o aaxcleannative.dll AacEncoder.o AacDecoder.o -L$FFMPEG_MAIN/libavutil -L$FFMPEG_MAIN/libswscale -L$FFMPEG_MAIN/libswresample -L$FFMPEG_MAIN/libavcodec -L$FFMPEG_MAIN/libavformat -L$FFMPEG_MAIN/libavfilter -L$FFMPEG_MAIN/libavdevice -lavfilter -lswresample -lavformat -lavcodec -lavutil -lfdk-aac -lmp3lame -lbcrypt
          
          mv aaxcleannative.dll ../$DEST_DIR/

      - name: Bundle Artifacts
        id: bundle
        working-directory: ./src
        run: |
          ARTIFACT=native_win-${{ inputs.architecture }}.tar.gz
          tar -cz -f $ARTIFACT runtimes
          echo "artifact=${ARTIFACT}" >> "${GITHUB_OUTPUT}"
        
      - name: Upload library
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.bundle.outputs.artifact }}
          path: ./src/${{ steps.bundle.outputs.artifact }}
          if-no-files-found: error
          retention-days: 7
